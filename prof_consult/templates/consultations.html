{% extends 'base.html' %}
{% load user_extras %}

{% block title %}My Consultations - Professor Consultation Scheduler{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-calendar-check text-primary"></i> My Consultations
            </h1>
            <p class="lead text-muted">View and manage your scheduled consultation sessions</p>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-4" id="consultationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if status_filter == 'upcoming' or not status_filter %}active{% endif %}" 
               href="?status=upcoming">
                <i class="bi bi-clock"></i> Upcoming
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if status_filter == 'past' %}active{% endif %}" 
               href="?status=past">
                <i class="bi bi-check-circle"></i> Past
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if status_filter == 'cancelled' %}active{% endif %}" 
               href="?status=cancelled">
                <i class="bi bi-x-circle"></i> Cancelled
            </a>
        </li>
    </ul>

    <div class="tab-content" id="consultationTabsContent">
        <div class="tab-pane fade show active" role="tabpanel">
            {% if consultations %}
                <div class="row g-4">
                    {% for consultation in consultations %}
                    <div class="col-12">
                        <div class="card shadow-sm hover-lift consultation-card animate-on-scroll" data-status="{{ consultation.status|lower }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2 text-center">
                                        <div class="display-6 fw-bold text-primary">{{ consultation.scheduled_date|date:"d" }}</div>
                                        <div class="text-muted">{{ consultation.scheduled_date|date:"M Y"|upper }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="card-title mb-2">
                                            <i class="bi bi-person-circle"></i> 
                                            {% if user.role == 'STUDENT' %}
                                                {{ consultation.professor|display_name }}
                                            {% else %}
                                                {{ consultation.student|display_name }}
                                            {% endif %}
                                        </h5>
                                        <p class="card-text mb-2">
                                            <i class="bi bi-clock text-muted"></i> 
                                            {{ consultation.scheduled_time|time:"g:i A" }} 
                                            ({{ consultation.duration }} min)
                                        </p>
                                        <p class="card-text mb-0">
                                            <i class="bi bi-geo-alt text-muted"></i> 
                                            {{ consultation.location|default:"Location TBD" }}
                                        </p>
                                        <p class="card-text mb-0 mt-2">
                                            <strong>{{ consultation.title }}</strong>
                                        </p>
                                        {% if consultation.status == 'PENDING' %}
                                            <span class="badge bg-warning mt-2">Pending</span>
                                        {% elif consultation.status == 'CONFIRMED' %}
                                            <span class="badge bg-success mt-2">Confirmed</span>
                                        {% elif consultation.status == 'COMPLETED' %}
                                            <span class="badge bg-info mt-2">Completed</span>
                                        {% elif consultation.status == 'CANCELLED' %}
                                            <span class="badge bg-danger mt-2">Cancelled</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                        {% if status_filter == 'upcoming' or not status_filter %}
                                            <div class="btn-group w-100 mb-2" role="group">
                                                <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-primary btn-sm">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                                {% if consultation.status != 'CANCELLED' %}
                                                    <button type="button" class="btn btn-warning btn-sm btn-reschedule" data-id="{{ consultation.id }}">
                                                        <i class="bi bi-pencil"></i> Reschedule
                                                    </button>
                                                    <button type="button" class="btn btn-danger btn-sm btn-cancel" data-id="{{ consultation.id }}">
                                                        <i class="bi bi-x-circle"></i> Cancel
                                                    </button>
                                                {% endif %}
                                            </div>
                                            {% if consultation.google_calendar_event_id %}
                                                <div class="mt-2">
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-google"></i> In Calendar
                                                    </span>
                                                </div>
                                            {% else %}
                                                <div class="mt-2">
                                                    <a href="#" class="btn btn-success btn-sm w-100">
                                                        <i class="bi bi-google"></i> Add to Calendar
                                                    </a>
                                                </div>
                                            {% endif %}
                                        {% elif status_filter == 'past' %}
                                            <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-eye"></i> View Details
                                            </a>
                                            {% if consultation.rating %}
                                                <div class="mt-2">
                                                    <span class="text-warning">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= consultation.rating %}
                                                                <i class="bi bi-star-fill"></i>
                                                            {% else %}
                                                                <i class="bi bi-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </span>
                                                </div>
                                            {% else %}
                                                <a href="#" class="btn btn-warning btn-sm mt-2">
                                                    <i class="bi bi-star"></i> Rate Consultation
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> 
                    {% if status_filter == 'upcoming' %}
                        No upcoming consultations. <a href="{% url 'book_consultation' %}" class="alert-link">Book one now!</a>
                    {% elif status_filter == 'past' %}
                        No past consultations yet.
                    {% elif status_filter == 'cancelled' %}
                        No cancelled consultations.
                    {% else %}
                        No consultations found.
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- Cancel & Reschedule Modals (used by list inline AJAX) -->
<div class="modal fade" id="listCancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="list-cancel-reason" class="form-label">Reason (optional)</label>
                    <input id="list-cancel-reason" class="form-control" placeholder="Optional reason for cancellation">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="list-confirm-cancel" class="btn btn-danger">Cancel Consultation</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="listRescheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reschedule Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-6">
                        <label for="list-new-date" class="form-label">New Date</label>
                        <input id="list-new-date" type="date" class="form-control">
                        <div id="list-reschedule-date-feedback" class="form-text text-danger" style="display:none">Please choose a valid date.</div>
                    </div>
                    <div class="col-6">
                        <label for="list-new-time" class="form-label">New Time</label>
                        <select id="list-new-time" class="form-select" required>
                            <option value="" selected>Choose a time slot...</option>
                            <option value="09:00">9:00 AM - 10:00 AM</option>
                            <option value="10:00">10:00 AM - 11:00 AM</option>
                            <option value="11:00">11:00 AM - 12:00 PM</option>
                            <option value="14:00">2:00 PM - 3:00 PM</option>
                            <option value="15:00">3:00 PM - 4:00 PM</option>
                            <option value="16:00">4:00 PM - 5:00 PM</option>
                        </select>
                        <div id="list-reschedule-feedback" class="form-text text-danger" style="display:none">Please choose a valid time slot.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="list-confirm-reschedule" class="btn btn-primary" disabled>Reschedule</button>
            </div>
        </div>
    </div>
</div>

<script>
;(function(){
    // Helper: read CSRF token if present
    function getAuthHeaders(){
        const csrfEl = document.querySelector('[name=csrfmiddlewaretoken]');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfEl) headers['X-CSRFToken'] = csrfEl.value;
        return headers;
    }

    // Keep track of active consultation id when modal is open
    let activeConsultationId = null;

    // Cancel flow
    document.querySelectorAll('.btn-cancel').forEach(btn => {
        btn.addEventListener('click', () => {
            activeConsultationId = btn.dataset.id;
            const reasonInput = document.getElementById('list-cancel-reason');
            if (reasonInput) reasonInput.value = '';
            const modalEl = document.getElementById('listCancelModal');
            new bootstrap.Modal(modalEl).show();
        });
    });

    document.getElementById('list-confirm-cancel').addEventListener('click', function(){
        const reason = document.getElementById('list-cancel-reason').value || '';
        const btn = this; btn.disabled = true;
        fetch(`/api/consultations/${activeConsultationId}/cancel/`, {
            method: 'PATCH',
            headers: getAuthHeaders(),
            credentials: 'same-origin',
            body: JSON.stringify({ reason })
        }).then(async res => {
            btn.disabled = false;
            if (res.ok){
                // hide modal and redirect explicitly to consultations list
                try{
                    const modalEl = document.getElementById('listCancelModal');
                    if (modalEl){
                        const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        m.hide();
                    }
                } catch (e) {
                    // ignore
                }
                window.location.href = '/consultations/?status=upcoming';
            } else {
                const data = await res.json().catch(()=>({}));
                alert(data.error || 'Failed to cancel consultation');
            }
        }).catch(() => { btn.disabled = false; alert('Network error while cancelling'); });
    });

    // Reschedule flow
    document.querySelectorAll('.btn-reschedule').forEach(btn => {
        btn.addEventListener('click', () => {
            activeConsultationId = btn.dataset.id;
            // reset inputs
            const dateEl = document.getElementById('list-new-date');
            const timeEl = document.getElementById('list-new-time');
            const feedback = document.getElementById('list-reschedule-feedback');
            const confirmBtn = document.getElementById('list-confirm-reschedule');
            if (dateEl) dateEl.value = '';
            if (timeEl) timeEl.value = '';
            if (feedback) feedback.style.display = 'none';
            if (confirmBtn) confirmBtn.disabled = true;
            const modalEl = document.getElementById('listRescheduleModal');
            new bootstrap.Modal(modalEl).show();

            // attach listeners to enable confirm button when valid
            let dateTouched = false;
            let timeTouched = false;

            function toggleConfirm(){
                const date = dateEl ? dateEl.value : '';
                const time = timeEl ? timeEl.value : '';
                const dateOk = Boolean(date);
                const timeOk = Boolean(time) && time !== '';
                if (confirmBtn) confirmBtn.disabled = !(dateOk && timeOk);

                // Show feedback only after the user has interacted with the field
                if (feedback) feedback.style.display = (timeTouched && !timeOk ? 'block' : 'none');
                const dateFeedback = document.getElementById('list-reschedule-date-feedback');
                if (dateFeedback) dateFeedback.style.display = (dateTouched && !dateOk ? 'block' : 'none');
            }

            if (dateEl) {
                dateEl.addEventListener('input', function(){ dateTouched = true; toggleConfirm(); });
                dateEl.addEventListener('blur', function(){ dateTouched = dateTouched || dateEl.value !== ''; toggleConfirm(); });
            }
            if (timeEl) {
                timeEl.addEventListener('change', function(){ timeTouched = true; toggleConfirm(); });
            }
        });
    });

    document.getElementById('list-confirm-reschedule').addEventListener('click', function(){
        const date = document.getElementById('list-new-date').value;
        const time = document.getElementById('list-new-time').value;
        if (!date || !time){ alert('Please provide both date and time'); return; }
        const btn = this; btn.disabled = true;
        fetch(`/api/consultations/${activeConsultationId}/reschedule/`, {
            method: 'PATCH',
            headers: getAuthHeaders(),
            credentials: 'same-origin',
            body: JSON.stringify({ scheduled_date: date, scheduled_time: time })
        }).then(async res => {
            btn.disabled = false;
            if (res.ok){ location.reload(); }
            else { const data = await res.json().catch(()=>({})); alert(data.error || 'Failed to reschedule consultation'); }
        }).catch(() => { btn.disabled = false; alert('Network error while rescheduling'); });
    });

    document.querySelectorAll('.add-to-calendar-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const consultationId = btn.dataset.consultationId;

            const response = await fetch(`/api/consultations/${consultationId}/add_to_calendar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // only if needed
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok && data.event_url) {
                // Open Google Calendar event in a new tab
                window.open(data.event_url, '_blank');
            } else {
                alert(data.detail || 'Failed to add to Google Calendar');
            }
        });
    });
})();
</script>
{% endblock %}
