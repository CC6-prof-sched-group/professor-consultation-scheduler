{% extends 'base.html' %}
{% load user_extras avatar_extras %}

{% block title %}My Profile - ConsultEase{% endblock %}

{% block content %}
<div class="container my-5">
    <style>
        /* Small local palette utilities for profile settings */
        .sidebar .list-group-item.active {
            background-color: transparent !important;
            color: #274572 !important;
            border-left: 4px solid #5389DA !important;
            font-weight: 600;
        }
        .sidebar .list-group-item {
            color: #274572;
        }
        .sidebar .list-group-item:hover {
            background-color: #5389DA10;
            color: #274572;
        }
        .avatar-bubble {
            width: 120px; height: 120px; border-radius: 50%;
            background: linear-gradient(135deg, #74D3D3 0%, #5389DA 100%);
            color: #ffffff; display:flex; align-items:center; justify-content:center; overflow:hidden;
        }
        .btn-change-photo { background-color: transparent; border: 1px solid #74D3D3; color: #274572; }
        .card-top-accent { border-top: 4px solid #5389DA; }
        .card-top-accent-accent { border-top: 4px solid #74D3D3; }
        .danger-card { border-color: #a71d2a; }
        .danger-header { background-color: transparent; border-bottom: 1px solid #e9ecef; color: #a71d2a; padding: 1rem 1.25rem; }
        .card-header.transparent { background-color: transparent; border-bottom: 1px solid #e9ecef; padding: 1rem 1.25rem; }
    </style>
    <div class="row">
        <div class="col-md-3 sidebar">
            <!-- Sidebar Navigation -->
            <div class="card shadow-sm mb-4">
                <div class="card-header transparent">
                    <h5 class="mb-0" style="color: #274572;"><i class="bi bi-gear" style="color: #5389DA;"></i> Settings</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                        <i class="bi bi-person"></i> Profile Information
                    </a>
                    <a href="#account" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-shield-lock"></i> Account Settings
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-bell"></i> Notifications
                    </a>
                    <a href="#preferences" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="bi bi-sliders"></i> Preferences
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="tab-content">
                <!-- Profile Information -->
                <div class="tab-pane fade show active" id="profile">
                    <div class="card shadow-sm card-top-accent">
                        <div class="card-header transparent">
                            <h4 class="mb-0" style="color: #274572;"><i class="bi bi-person-circle" style="color: #5389DA;"></i> Profile Information</h4>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                
                                <!-- Profile Picture -->
                                <div class="text-center mb-4">
                                    {% user_avatar user as avatar_url %}
                                    <div class="avatar-bubble mx-auto mb-3">
                                        {% if avatar_url %}
                                            <img src="{{ avatar_url }}" alt="Avatar" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;" />
                                        {% else %}
                                            <i class="bi bi-person-fill" style="font-size:48px"></i>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-change-photo">
                                        <i class="bi bi-camera"></i> Change Photo
                                    </button>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" name="first_name" value="{{ user.first_name }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="lastName" name="last_name" value="{{ user.last_name }}">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" value="{{ user.email }}" readonly>
                                    <div class="form-text">Email cannot be changed as it's linked to your Google account.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" value="{{ user.phone|default:'' }}" placeholder="+1 (555) 123-4567">
                                </div>

                                <div class="mb-3">
                                    <label for="bio" class="form-label">Bio</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="Tell us about yourself...">{{ user.bio|default:'' }}</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="department" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="department" name="department" value="{{ user.department|default:'' }}" placeholder="e.g., Computer Science">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="role" class="form-label">Role</label>
                                        <input type="text" class="form-control" id="role" value="{{ user.get_role_display }}" readonly>
                                    </div>
                                </div>

                                {% if user.role == 'STUDENT' %}
                                <div class="mb-3">
                                    <label for="studentId" class="form-label">Student ID</label>
                                    <input type="text" class="form-control" id="studentId" name="student_id" value="{{ user.student_id|default:'' }}" placeholder="e.g. 202111234">
                                </div>
                                {% endif %}

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn" style="background-color: #5389DA; border-color: #5389DA; color: white;">
                                        <i class="bi bi-check-circle"></i> Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="tab-pane fade" id="account">
                    <div class="card shadow-sm">
                        <div class="card-header" style="background-color: transparent; border-bottom: 1px solid #e9ecef;">
                            <h4 class="mb-0" style="color: #274572;"><i class="bi bi-shield-lock" style="color: #5389DA;"></i> Account Settings</h4>
                        </div>
                        <div class="card-body">
                            <!-- Connected Accounts -->
                            <h5 class="mb-3">Connected Accounts</h5>
                            <div class="list-group mb-4">
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-google fs-4" style="color: #5389DA; "></i>
                                            <span class="ms-2"><strong>Google</strong></span>
                                            <br>
                                            <small class="text-muted ms-5">Connected as john.doe@university.edu</small>
                                        </div>
                                        <span class="badge bg-success">Connected</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Privacy Settings -->
                            <h5 class="mb-3">Privacy Settings</h5>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="profileVisible" checked>
                                <label class="form-check-label" for="profileVisible">
                                    Make my profile visible to others
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="showEmail">
                                <label class="form-check-label" for="showEmail">
                                    Show my email to professors
                                </label>
                            </div>
                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" id="activityLog" checked>
                                <label class="form-check-label" for="activityLog">
                                    Keep activity log
                                </label>
                            </div>

                            {% if user.role == 'STUDENT' %}
                            <!-- Testing Tools -->
                            <div class="card mb-4 card-top-accent-accent" style="border-color: #74D3D3;">
                                <div class="card-header transparent">
                                    <h5 class="mb-0" style="color: #274572;"><i class="bi bi-tools" style="color: #74D3D3;"></i> Testing Tools</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Convert your student account to a professor account for testing purposes.</p>
                                    <form method="post" action="{% url 'convert_to_professor' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn" style="background-color: #74D3D3; border-color: #74D3D3; color: #ffffff;" onclick="return confirm('Are you sure you want to convert your account to a professor account? This will change your role and create a professor profile.')">
                                            <i class="bi bi-person-badge"></i> Convert to Professor
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Developer Options -->
                            <div class="card mb-4 border-warning">
                                <div class="card-header transparent">
                                    <h5 class="mb-0 text-warning"><i class="bi bi-code-square"></i> Developer Options</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">These options are for development and testing purposes.</p>
                                    {% if not user.is_superuser %}
                                    <form action="{% url 'become_admin' %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-warning text-dark">
                                            <i class="bi bi-shield-lock"></i> Make Me Admin
                                        </button>
                                    </form>
                                    {% else %}
                                    <p class="text-success mb-0"><i class="bi bi-check-circle"></i> You are an Administrator.</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Danger Zone -->
                            <div class="card danger-card">
                                <div class="card-header danger-header">
                                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle" style="color: #a71d2a;"></i> Danger Zone</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Once you delete your account, there is no going back. Please be certain.</p>
                                    <button type="button" class="btn" style="background-color: #a71d2a; border-color: #a71d2a; color: white;" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                        <i class="bi bi-trash"></i> Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="tab-pane fade" id="notifications">
                    <div class="card shadow-sm">
                        <div class="card-header" style="background-color: transparent; border-bottom: 1px solid #e9ecef;">
                            <h4 class="mb-0" style="color: #274572;"><i class="bi bi-bell" style="color: #5389DA;"></i> Notification Preferences</h4>
                        </div>
                        <div class="card-body">
                            <h5 class="mb-3">Email Notifications</h5>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailUpcoming" checked>
                                <label class="form-check-label" for="emailUpcoming">
                                    <strong>Upcoming Consultations</strong>
                                    <br>
                                    <small class="text-muted">Get notified 24 hours before your consultation</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailConfirmation" checked>
                                <label class="form-check-label" for="emailConfirmation">
                                    <strong>Booking Confirmations</strong>
                                    <br>
                                    <small class="text-muted">Receive confirmation when a booking is made</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailCancellation" checked>
                                <label class="form-check-label" for="emailCancellation">
                                    <strong>Cancellations</strong>
                                    <br>
                                    <small class="text-muted">Get notified when a consultation is cancelled</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" id="emailReminder" checked>
                                <label class="form-check-label" for="emailReminder">
                                    <strong>Reminders</strong>
                                    <br>
                                    <small class="text-muted">Receive reminder emails before consultations</small>
                                </label>
                            </div>

                            <hr>

                            <h5 class="mb-3">In-App Notifications</h5>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="appMessages" checked>
                                <label class="form-check-label" for="appMessages">
                                    New messages from professors
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="appUpdates" checked>
                                <label class="form-check-label" for="appUpdates">
                                    System updates and announcements
                                </label>
                            </div>

                            <button type="submit" class="btn" style="background-color: #5389DA; border-color: #5389DA; color: white;" >
                                <i class="bi bi-check-circle"></i> Save Preferences
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="tab-pane fade" id="preferences">
                    <div class="card shadow-sm">
                        <div class="card-header" style="background-color: transparent; border-bottom: 1px solid #e9ecef;">
                            <h4 class="mb-0" style="color: #274572;"><i class="bi bi-sliders" style="color: #5389DA;"></i> General Preferences</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="timezone" class="form-label"><strong>Timezone</strong></label>
                                <select class="form-select" id="timezone">
                                    <option selected>UTC (Coordinated Universal Time)</option>
                                    <option>EST (Eastern Standard Time)</option>
                                    <option>PST (Pacific Standard Time)</option>
                                    <option>CST (Central Standard Time)</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="language" class="form-label"><strong>Language</strong></label>
                                <select class="form-select" id="language">
                                    <option selected>English</option>
                                    <option>Spanish</option>
                                    <option>French</option>
                                    <option>German</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label"><strong>Default Consultation Duration</strong></label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="duration" id="duration30" autocomplete="off">
                                    <label class="btn" for="duration30" style="border: 1px solid #5389DA; color: #5389DA;">30 min</label>

                                    <input type="radio" class="btn-check" name="duration" id="duration60" autocomplete="off" checked>
                                    <label class="btn" for="duration60" style="border: 1px solid #5389DA; color: #5389DA;">60 min</label>

                                    <input type="radio" class="btn-check" name="duration" id="duration90" autocomplete="off">
                                    <label class="btn" for="duration90" style="border: 1px solid #5389DA; color: #5389DA;">90 min</label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label"><strong>Calendar Sync</strong></label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="syncGoogle" checked>
                                    <label class="form-check-label" for="syncGoogle">
                                        Automatically sync with Google Calendar
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn" style="background-color: #5389DA; border-color: #5389DA; color: white;">
                                <i class="bi bi-check-circle"></i> Save Preferences
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #a71d2a; color: white;">
                <h5 class="modal-title" id="deleteModalLabel">Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                <p class="mb-0 text-danger"><strong>All your data will be permanently deleted.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_account' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background-color: #a71d2a; border-color: #a71d2a; color: white;">Delete My Account</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
