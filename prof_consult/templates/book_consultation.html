{% extends 'base.html' %}
{% load user_extras static %}

{% block title %}Book Consultation - ConsultEase{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg scale-in" style="border: none; border-top: 4px solid #5389DA;">
                <div class="card-header" style="background-color: transparent; border-bottom: 1px solid #e9ecef; padding: 1.25rem;">
                    <h3 class="mb-0" style="color: #274572;">
                        <i class="bi bi-calendar-plus bounce" style="color: #5389DA;"></i> Book a Consultation
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="bookingForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Professor Selection -->
                        <div class="mb-4">
                            <label for="professor" class="form-label fw-bold">
                                <i class="bi bi-person"></i> Select Professor
                            </label>
                            <select class="form-select form-select-lg" id="professor" name="professor" required>
                                <option value="">Choose a professor...</option>
                                {% for professor in professors %}
                                <option value="{{ professor.id }}">{{ professor|display_name }} - {{ professor.department }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Date Selection -->
                        <div class="mb-4">
                            <label for="date" class="form-label fw-bold">
                                <i class="bi bi-calendar3"></i> Consultation Date
                            </label>
                            <input type="date" class="form-control form-control-lg" id="date" name="date" required>
                        </div>

                        <!-- Time Slot Selection -->
                        <div class="mb-4">
                            <label for="time" class="form-label fw-bold">
                                <i class="bi bi-clock"></i> Time Slot
                            </label>
                            <input type="time" class="form-control form-control-lg" id="time" name="time" required>
                            <div class="form-text">Select your preferred consultation time</div>
                        </div>

                        <!-- Duration Selection -->
                        <div class="mb-4">
                            <label for="duration" class="form-label fw-bold">
                                <i class="bi bi-hourglass-split"></i> Duration
                            </label>
                            <select class="form-select form-select-lg" id="duration" name="duration" required>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes</option>
                            </select>
                        </div>

                        <!-- Availability Indicator -->
                        <div id="availabilityIndicator" style="display: none;"></div>

                        <!-- Consultation Type -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-geo-alt"></i> Consultation Type
                            </label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="type" id="inPerson" value="in_person" checked>
                                    <label class="form-check-label" for="inPerson">
                                        In-Person
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="type" id="online" value="online">
                                    <label class="form-check-label" for="online">
                                        Online (Google Meet)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Topic/Subject -->
                        <div class="mb-4">
                            <label for="subject" class="form-label fw-bold">
                                <i class="bi bi-bookmark"></i> Topic/Subject
                            </label>
                            <input type="text" class="form-control form-control-lg" id="subject" name="subject" placeholder="e.g., Data Structures - Binary Trees" required>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label fw-bold">
                                <i class="bi bi-chat-text"></i> Additional Notes (Optional)
                            </label>
                            <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="Any specific questions or topics you'd like to discuss..."></textarea>
                            <div class="form-text">Please provide any relevant details that might help the professor prepare for the consultation.</div>
                        </div>

                        <!-- Notification Preferences -->
                        <div class="mb-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-bell"></i> Notification Preferences
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailNotif" name="email_notification" checked>
                                        <label class="form-check-label" for="emailNotif">
                                            Send email notification
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="calendarAdd" name="add_to_calendar" checked>
                                        <label class="form-check-label" for="calendarAdd">
                                            Add to Google Calendar
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="reminder" name="reminder" checked>
                                        <label class="form-check-label" for="reminder">
                                            Send reminder 24 hours before
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-lg" style="background-color: #5389DA; border-color: #5389DA; color: white;">
                                <i class="bi bi-check-circle"></i> Confirm Booking
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Booking Guidelines -->
            <div class="card mt-4" style="border: none; border-top: 4px solid #74D3D3;">
                <div class="card-header" style="background-color: transparent; border-bottom: 1px solid #e9ecef; padding: 1.25rem;">
                    <h5 class="mb-0" style="color: #274572;"><i class="bi bi-info-circle" style="color: #74D3D3;"></i> Booking Guidelines</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Book at least 24 hours in advance</li>
                        <li>Cancellations must be made at least 6 hours before the scheduled time</li>
                        <li>Please arrive 5 minutes early for in-person consultations</li>
                        <li>For online consultations, you'll receive a Google Meet link via email</li>
                        <li>Maximum consultation duration is 1 hour</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Real-time Availability Checker
document.addEventListener('DOMContentLoaded', function() {
    const professorSelect = document.getElementById('professor');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const durationInput = document.getElementById('duration');
    const submitButton = document.querySelector('button[type="submit"]');
    const availabilityIndicator = document.getElementById('availabilityIndicator');
    
    // Debounce function to avoid too many API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Check availability function
    async function checkAvailability() {
        const professorId = professorSelect?.value;
        const date = dateInput?.value;
        const time = timeInput?.value;
        const duration = durationInput?.value || 30;
        
        // Don't check if required fields are empty
        if (!professorId || !date || !time) {
            hideAvailabilityIndicator();
            enableSubmitButton();
            return;
        }
        
        // Show loading state
        showLoadingIndicator();
        
        try {
            const formData = new FormData();
            formData.append('professor_id', professorId);
            formData.append('date', date);
            formData.append('time', time);
            formData.append('duration', duration);
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const response = await fetch('/api/check-availability/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.available) {
                showAvailableIndicator(data.message);
                enableSubmitButton();
            } else {
                showUnavailableIndicator(data.message);
                disableSubmitButton();
            }
        } catch (error) {
            console.error('Error checking availability:', error);
            showErrorIndicator('Unable to check availability. Please try again.');
            enableSubmitButton(); // Allow submission if check fails
        }
    }
    
    // Debounced version of checkAvailability
    const debouncedCheck = debounce(checkAvailability, 500);
    
    // Add event listeners
    if (professorSelect) {
        professorSelect.addEventListener('change', debouncedCheck);
    }
    
    if (dateInput) {
        dateInput.addEventListener('change', debouncedCheck);
    }
    
    if (timeInput) {
        timeInput.addEventListener('change', debouncedCheck);
    }
    
    if (durationInput) {
        durationInput.addEventListener('change', debouncedCheck);
    }
    
    // UI update functions
    function showLoadingIndicator() {
        if (!availabilityIndicator) return;
        
        availabilityIndicator.className = 'alert alert-info d-flex align-items-center mt-3';
        availabilityIndicator.innerHTML = `
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Checking availability...</span>
        `;
        availabilityIndicator.style.display = 'block';
    }
    
    function showAvailableIndicator(message) {
        if (!availabilityIndicator) return;
        
        availabilityIndicator.className = 'alert alert-success d-flex align-items-center mt-3';
        availabilityIndicator.innerHTML = `
            <i class="bi bi-check-circle-fill me-2 fs-5"></i>
            <span><strong>Available!</strong> ${message}</span>
        `;
        availabilityIndicator.style.display = 'block';
    }
    
    function showUnavailableIndicator(message) {
        if (!availabilityIndicator) return;
        
        availabilityIndicator.className = 'alert alert-danger d-flex align-items-center mt-3';
        availabilityIndicator.innerHTML = `
            <i class="bi bi-x-circle-fill me-2 fs-5"></i>
            <span><strong>Not Available.</strong> ${message}</span>
        `;
        availabilityIndicator.style.display = 'block';
    }
    
    function showErrorIndicator(message) {
        if (!availabilityIndicator) return;
        
        availabilityIndicator.className = 'alert alert-warning d-flex align-items-center mt-3';
        availabilityIndicator.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
            <span>${message}</span>
        `;
        availabilityIndicator.style.display = 'block';
    }
    
    function hideAvailabilityIndicator() {
        if (!availabilityIndicator) return;
        availabilityIndicator.style.display = 'none';
    }
    
    function enableSubmitButton() {
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.classList.remove('disabled');
        }
    }
    
    function disableSubmitButton() {
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.classList.add('disabled');
        }
    }
    
    // Set minimum date to today
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
    }
    
    // Prevent form submission if not available
    const bookingForm = document.getElementById('bookingForm');
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            if (submitButton && submitButton.disabled) {
                e.preventDefault();
                alert('Please select an available time slot before submitting.');
                return false;
            }
        });
    }
});
</script>
{% endblock %}